<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Расписание фестиваля</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="/static/leaflet.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            height: 100%;
            width: 100%;
            -webkit-text-size-adjust: 100%;
            touch-action: none;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        .time-column {
            position: fixed;
            left: 0;
            top: 0;
            width: 30px;
            height: 100vh;
            background: transparent;
            color: #fff;
            font-size: 12px;
            text-align: center;
            z-index: 2;
            pointer-events: none;
        }
        .stage-row {
            position: fixed;
            top: 0;
            left: 0;
            height: 30px;
            width: 100vw;
            background: transparent;
            color: #fff;
            font-size: 12px;
            text-align: center;
            z-index: 2;
            pointer-events: none;
        }
        .timeline {
            position: fixed;
            width: 100%;
            height: 2px;
            background: red;
            z-index: 3;
            transition: top 0.5s;
            pointer-events: none;
        }
        .error {
            color: red;
            text-align: center;
            padding: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4;
        }
        .event-marker {
            background: transparent !important;
            border: none !important;
        }
        .event-marker div {
            background: transparent !important;
            border: none !important;
            color: #fff !important;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="time-column" id="timeColumn"></div>
    <div class="stage-row" id="stageRow"></div>
    <div class="timeline" id="timeline"></div>
    <script>
        window.onload = () => {
            // Отключаем зум страницы
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.addEventListener('gesturechange', (e) => e.preventDefault());
            document.addEventListener('gestureend', (e) => e.preventDefault());

            // Инициализация карты
            const map = L.map('map', {
                crs: L.CRS.Simple,
                minZoom: 0,
                maxZoom: 3,
                zoom: 0,
                center: [0, 0],
                zoomControl: false,
                attributionControl: false,
                inertia: true,
                bounceAtZoomLimits: false
            });

            // Настраиваем размеры карты
            const mapWidth = window.innerWidth;
            const mapHeight = window.innerHeight;
            const bounds = [[0, 0], [mapHeight, mapWidth]];
            L.imageOverlay('#333', bounds).addTo(map); // Фон
            map.setMaxBounds(bounds);

            // Константы
            const timeColumnWidth = 30;
            const stageColumnWidth = 100;
            const headerHeight = 30;
            const cellHeight = 34;
            const times = [];
            const startDate = new Date('2025-05-29T15:00:00');
            const endDate = new Date('2025-06-01T23:00:00');

            for (let d = new Date(startDate); d <= endDate; d.setHours(d.getHours() + 1)) {
                const time = d.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: false });
                times.push(time);
            }

            let totalWidth = timeColumnWidth + 5 * stageColumnWidth;
            let totalHeight = headerHeight + times.length * cellHeight;

            // Обновление фиксированных элементов при скролле
            map.on('move', () => {
                const center = map.getCenter();
                const zoom = map.getZoom();
                const scale = Math.pow(2, zoom);
                
                // Обновляем позиции фиксированных элементов
                const timeColumn = document.getElementById('timeColumn');
                const stageRow = document.getElementById('stageRow');
                
                // Обновляем содержимое столбца времени
                timeColumn.innerHTML = '';
                times.forEach((time, index) => {
                    const y = headerHeight + index * cellHeight;
                    const screenY = (y - center.y) * scale + window.innerHeight / 2;
                    if (screenY >= 0 && screenY <= window.innerHeight) {
                        const timeDiv = document.createElement('div');
                        timeDiv.style.position = 'absolute';
                        timeDiv.style.top = `${screenY}px`;
                        timeDiv.style.width = '100%';
                        timeDiv.style.height = `${cellHeight}px`;
                        timeDiv.style.lineHeight = `${cellHeight}px`;
                        timeDiv.textContent = time;
                        timeColumn.appendChild(timeDiv);
                    }
                });

                // Обновляем содержимое строки сцен
                stageRow.innerHTML = '';
                const stages = ['JEON', 'DARK', 'wmast', 'Shadow', 'onPulse'];
                stages.forEach((stage, index) => {
                    const x = timeColumnWidth + index * stageColumnWidth;
                    const screenX = (x - center.x) * scale + window.innerWidth / 2;
                    if (screenX >= 0 && screenX <= window.innerWidth) {
                        const stageDiv = document.createElement('div');
                        stageDiv.style.position = 'absolute';
                        stageDiv.style.left = `${screenX}px`;
                        stageDiv.style.width = `${stageColumnWidth}px`;
                        stageDiv.style.height = '100%';
                        stageDiv.style.lineHeight = `${headerHeight}px`;
                        stageDiv.textContent = stage;
                        stageRow.appendChild(stageDiv);
                    }
                });
            });

            // Загрузка расписания
            function updateSchedule() {
                fetch('/api/schedule')
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(`Ошибка загрузки: ${err.error || response.statusText}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Очистка карты
                        map.eachLayer(layer => {
                            if (!layer instanceof L.Control) {
                                map.removeLayer(layer);
                            }
                        });

                        // Обновляем размеры на основе данных
                        totalWidth = timeColumnWidth + data.stages.length * stageColumnWidth;
                        totalHeight = headerHeight + times.length * cellHeight;
                        
                        // Устанавливаем границы карты
                        const bounds = [[0, 0], [totalHeight, totalWidth]];
                        map.setMaxBounds(bounds);
                        
                        // Устанавливаем начальный центр
                        map.setView([totalHeight / 2, totalWidth / 2], 0);

                        // Рисуем события
                        times.forEach((time, timeIndex) => {
                            const y = headerHeight + timeIndex * cellHeight;
                            data.stages.forEach((stage, stageIndex) => {
                                const x = timeColumnWidth + stageIndex * stageColumnWidth;
                                const event = stage.events.find(e =>
                                    e.time === `Thu ${time}` || e.time === `Fri ${time}` ||
                                    e.time === `Sat ${time}` || e.time === `Sun ${time}`
                                );
                                if (event) {
                                    const marker = L.marker([y + cellHeight / 2, x + stageColumnWidth / 2], {
                                        icon: L.divIcon({
                                            className: 'event-marker',
                                            html: `<div style="width: ${stageColumnWidth}px; height: ${cellHeight}px; line-height: ${cellHeight}px; text-align: center;">${event.dj}</div>`
                                        })
                                    }).addTo(map);
                                }
                            });
                        });
                    })
                    .catch(error => {
                        document.body.innerHTML = `<div class="error">${error.message}</div>`;
                    });
            }

            // Обновление таймлайна
            function updateTimeline() {
                fetch('/api/timeline')
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(`Ошибка таймлайна: ${err.error || response.statusText}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        const timeline = document.getElementById('timeline');
                        const mapHeight = map.getSize().y;
                        const scaledHeight = totalHeight * map.getZoom() / map.options.maxZoom;
                        timeline.style.top = `${(data.offset / 100) * scaledHeight}px`;
                    })
                    .catch(error => {
                        console.error('Ошибка таймлайна:', error);
                    });
            }

            // Периодическое обновление
            setInterval(() => {
                updateSchedule();
                updateTimeline();
            }, 30000);

            // Начальная загрузка
            updateSchedule();
            updateTimeline();

            // Обработка изменения размера окна
            window.addEventListener('resize', () => {
                const newWidth = window.innerWidth;
                const newHeight = window.innerHeight;
                map.setView([newHeight / 2, newWidth / 2], map.getZoom(), { animate: false });
                map.invalidateSize();
            });
        };
    </script>
</body>
</html>